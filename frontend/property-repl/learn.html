<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/svelte/compiler.js"></script>
</head>
<body>
<textarea id="svelte-code" style="width: 100%; height: 200px;"></textarea>
<button onclick="compileAndRun()">Compile and Run</button>
<div id="svelte-target"></div>

<script>
  let currentComponent = null; // Keep track of the current component
  let currentScript = null; // Keep track of the current script element

  function hostFunction() {
    alert('This function is from the host component!');
  }

  async function compileAndRun() {
    // Retrieve Svelte code from textarea
    const svelteCode = document.getElementById('svelte-code').value;

    // Compile the Svelte code to JavaScript
    const compiled = svelte.compile(svelteCode, {});

    // Destroy the current component if it exists
    if (currentComponent) {
      currentComponent.$destroy();
      currentComponent = null;
    }

    // Remove the previous script element if it exists
    if (currentScript) {
      document.body.removeChild(currentScript);
      currentScript = null;
    }

    // Clear the target element's content
    const targetElement = document.getElementById('svelte-target');
    targetElement.innerHTML = '';

    // Create a new script element
    const script = document.createElement('script');
    script.type = 'module';

    // Build the code to instantiate the component, also replace the import
    const codeToInstantiate = `
    ${compiled.js.code.replace('from "svelte/internal"', 'from "https://cdn.skypack.dev/svelte/internal"').replace('export default', 'window.Component =')}
    window.currentComponent = new window.Component({
        target: document.getElementById('svelte-target'),
        props: {
            prop1: 'This is the value for prop1',
            onHostAction: hostFunction
        }
    });
`;
    // Create a blob from the code and set it as the source for the script tag
    const blob = new Blob([codeToInstantiate], {type: 'application/javascript'});
    script.src = URL.createObjectURL(blob);

    // Append the script element to the document to execute it
    document.body.appendChild(script);

    // Keep track of the script element
    currentScript = script;
  }
</script>
</body>
</html>
